# Requirements Document

## Introduction

This feature extends the Birthday Notification System to support WhatsApp notifications in addition to email notifications. Users will be able to specify their preferred notification channel (email, WhatsApp, or both) in the Excel spreadsheet, and the system will deliver personalized birthday messages through the selected channels using Twilio's WhatsApp Business API.

## Glossary

- **Notification System**: The Birthday Notification System application that sends birthday reminders
- **WhatsApp Service**: The service component responsible for sending WhatsApp messages via Twilio API
- **Twilio**: Third-party service provider for WhatsApp Business API integration
- **Notification Channel**: The delivery method for birthday messages (email, WhatsApp, or both)
- **Birthday Record**: A data entry containing person's name, contact information, birthday, and notification preferences
- **Excel Reader**: The component that parses birthday data from Excel files
- **Template Engine**: The component that generates personalized message content

## Requirements

### Requirement 1

**User Story:** As a system administrator, I want to configure Twilio WhatsApp API credentials, so that the system can send WhatsApp messages

#### Acceptance Criteria

1. THE Notification System SHALL read Twilio Account SID from environment configuration
2. THE Notification System SHALL read Twilio Auth Token from environment configuration
3. THE Notification System SHALL read Twilio WhatsApp phone number from environment configuration
4. WHEN the Notification System starts, THE Notification System SHALL validate that all required Twilio credentials are present
5. IF Twilio credentials are missing, THEN THE Notification System SHALL log a warning and disable WhatsApp functionality

### Requirement 2

**User Story:** As a user, I want to specify my phone number and preferred notification channel in the Excel file, so that I receive birthday notifications through my chosen method

#### Acceptance Criteria

1. THE Excel Reader SHALL read a Phone column containing phone numbers in E.164 format
2. THE Excel Reader SHALL read a NotificationChannel column containing values: "email", "whatsapp", or "both"
3. WHEN NotificationChannel is empty or invalid, THE Excel Reader SHALL default to "email"
4. THE Excel Reader SHALL validate phone number format when NotificationChannel includes "whatsapp"
5. IF phone number is missing and NotificationChannel includes "whatsapp", THEN THE Excel Reader SHALL log a warning and fall back to email only

### Requirement 3

**User Story:** As a system, I want to send WhatsApp messages through Twilio API, so that users receive birthday notifications on WhatsApp

#### Acceptance Criteria

1. THE WhatsApp Service SHALL initialize a Twilio client with configured credentials
2. WHEN a birthday notification is required via WhatsApp, THE WhatsApp Service SHALL send a message using Twilio API
3. THE WhatsApp Service SHALL format the recipient phone number in E.164 format
4. THE WhatsApp Service SHALL use the configured Twilio WhatsApp sender number
5. THE WhatsApp Service SHALL include personalized message content generated by Template Engine

### Requirement 4

**User Story:** As a system, I want to handle WhatsApp delivery failures gracefully, so that the system remains stable and users are informed

#### Acceptance Criteria

1. WHEN WhatsApp message sending fails, THE WhatsApp Service SHALL log the error with recipient details
2. WHEN WhatsApp message sending fails, THE WhatsApp Service SHALL retry up to 3 times with exponential backoff
3. IF all retry attempts fail, THEN THE WhatsApp Service SHALL log a final failure message
4. THE WhatsApp Service SHALL continue processing remaining notifications after a failure
5. WHEN WhatsApp message is sent successfully, THE WhatsApp Service SHALL log success with recipient details

### Requirement 5

**User Story:** As a system, I want to support custom WhatsApp message templates, so that birthday messages can be personalized

#### Acceptance Criteria

1. THE Template Engine SHALL support a separate WhatsApp template file path in configuration
2. WHERE a custom WhatsApp template is configured, THE Template Engine SHALL load and use that template
3. WHERE no custom WhatsApp template is configured, THE Template Engine SHALL use the email template for WhatsApp messages
4. THE Template Engine SHALL replace {{name}} placeholder with recipient's name in WhatsApp messages
5. THE Template Engine SHALL support plain text format for WhatsApp messages

### Requirement 6

**User Story:** As a system administrator, I want to test WhatsApp connectivity on startup, so that I can verify the configuration is correct

#### Acceptance Criteria

1. WHEN the Notification System starts and WhatsApp is enabled, THE WhatsApp Service SHALL test the Twilio API connection
2. THE WhatsApp Service SHALL validate Twilio credentials during connection test
3. WHEN connection test succeeds, THE WhatsApp Service SHALL log success message
4. IF connection test fails, THEN THE WhatsApp Service SHALL log error details and disable WhatsApp functionality
5. THE Notification System SHALL continue operating with email-only mode if WhatsApp test fails

### Requirement 7

**User Story:** As a system, I want to send notifications through multiple channels based on user preferences, so that users receive messages on their preferred platforms

#### Acceptance Criteria

1. WHEN NotificationChannel is "email", THE Notification System SHALL send only email notification
2. WHEN NotificationChannel is "whatsapp", THE Notification System SHALL send only WhatsApp notification
3. WHEN NotificationChannel is "both", THE Notification System SHALL send both email and WhatsApp notifications
4. THE Notification System SHALL process email and WhatsApp notifications independently
5. IF one channel fails, THE Notification System SHALL still attempt delivery through the other channel

### Requirement 8

**User Story:** As a system administrator, I want comprehensive logging of WhatsApp operations, so that I can monitor and troubleshoot the system

#### Acceptance Criteria

1. THE WhatsApp Service SHALL log each WhatsApp message attempt with recipient name and phone number
2. THE WhatsApp Service SHALL log Twilio API response details for successful sends
3. THE WhatsApp Service SHALL log error details including error codes for failed sends
4. THE WhatsApp Service SHALL log retry attempts with attempt number
5. THE Notification System SHALL include WhatsApp statistics in daily summary logs
